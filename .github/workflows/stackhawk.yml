# GitHub Actions Workflow for StackHawk Security Scanning
# Scans backend and frontend for OWASP Top 10 vulnerabilities
# Runs on: push to main/develop, pull requests, manual trigger

name: StackHawk Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch: # Allow manual trigger
  schedule:
    - cron: '0 2 * * 1' # Weekly scan every Monday at 2 AM UTC

jobs:
  # Scan Backend API
  scan-backend:
    name: Scan Backend API
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start backend services
        run: |
          docker-compose up -d backend
          echo "Waiting for backend to be ready..."
          sleep 30
      
      - name: Verify backend health
        run: |
          curl -f http://localhost:8000/health || exit 1
          echo "✓ Backend is healthy"
      
      - name: Run StackHawk scan on Backend
        uses: stackhawk/hawkscan-action@v2
        with:
          apiKey: ${{ secrets.HAWK_API_KEY }}
          configurationFiles: stackhawk.yml
        env:
          HAWK_APP_ID: ${{ secrets.HAWK_BACKEND_APP_ID }}
          HAWK_ENV: CI
          APP_HOST: http://localhost:8000
          FAILURE_THRESHOLD: medium
          GIT_BRANCH: ${{ github.ref_name }}
          GIT_COMMIT_SHA: ${{ github.sha }}
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stackhawk-backend-results
          path: stackhawk-output/
          retention-days: 30
      
      - name: Stop backend services
        if: always()
        run: docker-compose down
  
  # Scan Frontend PWA
  scan-frontend:
    name: Scan Frontend PWA
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          REACT_APP_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      
      - name: Start frontend server
        run: |
          cd frontend
          npx serve -s build -l 3000 &
          echo "Waiting for frontend to be ready..."
          sleep 15
      
      - name: Verify frontend health
        run: |
          curl -f http://localhost:3000 || exit 1
          echo "✓ Frontend is serving"
      
      - name: Run StackHawk scan on Frontend
        uses: stackhawk/hawkscan-action@v2
        with:
          apiKey: ${{ secrets.HAWK_API_KEY }}
          configurationFiles: stackhawk-frontend.yml
        env:
          HAWK_FRONTEND_APP_ID: ${{ secrets.HAWK_FRONTEND_APP_ID }}
          HAWK_ENV: CI
          FRONTEND_HOST: http://localhost:3000
          FAILURE_THRESHOLD: medium
          GIT_BRANCH: ${{ github.ref_name }}
          GIT_COMMIT_SHA: ${{ github.sha }}
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stackhawk-frontend-results
          path: stackhawk-output/
          retention-days: 30
  
  # Combined scan summary
  scan-summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    needs: [scan-backend, scan-frontend]
    if: always()
    
    steps:
      - name: Download backend results
        uses: actions/download-artifact@v4
        with:
          name: stackhawk-backend-results
          path: backend-results/
        continue-on-error: true
      
      - name: Download frontend results
        uses: actions/download-artifact@v4
        with:
          name: stackhawk-frontend-results
          path: frontend-results/
        continue-on-error: true
      
      - name: Generate summary
        run: |
          echo "## StackHawk Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Status" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.scan-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.scan-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results at [StackHawk Dashboard](https://app.stackhawk.com/)" >> $GITHUB_STEP_SUMMARY
